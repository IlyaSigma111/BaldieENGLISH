<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BaldieEnglish ‚Äî –£—á–µ–Ω–∏–∫</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="joinForm" class="player-container">
        <div class="join-form">
            <h1>üè´ BaldieEnglish</h1>
            <h2 style="color: #888; margin-bottom: 2rem;">–í—Ö–æ–¥ –≤ –∏–≥—Ä—É</h2>
            
            <input type="text" id="gameCodeInput" placeholder="–ö–æ–¥ –∏–≥—Ä—ã" maxlength="6">
            <input type="text" id="playerName" placeholder="–¢–≤–æ–µ –∏–º—è">
            
            <select id="teamSelect">
                <option value="team1">üî¥ –ö–æ–º–∞–Ω–¥–∞ 1</option>
                <option value="team2">üîµ –ö–æ–º–∞–Ω–¥–∞ 2</option>
                <option value="team3">üü¢ –ö–æ–º–∞–Ω–¥–∞ 3</option>
            </select>
            
            <button id="joinGameBtn" class="join-btn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
        </div>
    </div>
    
    <div id="playerGame" style="display: none;">
        <div class="team-score" id="playerTeamScore">üî¥ 0</div>
        
        <canvas id="playerCanvas" class="game-canvas" width="400" height="400"></canvas>
        
        <div class="controls">
            <button class="control-btn up" id="moveUp">‚¨ÜÔ∏è</button>
            <button class="control-btn left" id="moveLeft">‚¨ÖÔ∏è</button>
            <button class="control-btn down" id="moveDown">‚¨áÔ∏è</button>
            <button class="control-btn right" id="moveRight">‚û°Ô∏è</button>
        </div>
    </div>
    
    <div id="questionPopup" class="question-popup">
        <h3 id="questionText">–í–æ–ø—Ä–æ—Å</h3>
        <input type="text" id="answerInput" placeholder="–¢–≤–æ–π –æ—Ç–≤–µ—Ç">
        <button id="submitAnswer">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
    </div>
    
    <div id="caughtMessage" class="caught-message">
        <h2>üò± BALDI –ü–û–ô–ú–ê–õ –¢–ï–ë–Ø!</h2>
        <p>–ü–æ–¥–æ–∂–¥–∏ 10 —Å–µ–∫—É–Ω–¥...</p>
    </div>

    <script type="module">
        import { database } from './firebase-config.js';
        import { ref, onValue, update, push } from 'firebase/database';
        
        let playerId = null;
        let gameCode = null;
        let currentTeam = null;
        let playerName = '';
        let currentQuestion = null;
        let isCaught = false;
        let caughtTimer = null;
        
        document.getElementById('joinGameBtn').onclick = () => {
            gameCode = document.getElementById('gameCodeInput').value.toUpperCase();
            playerName = document.getElementById('playerName').value;
            currentTeam = document.getElementById('teamSelect').value;
            
            if(!gameCode || !playerName) {
                alert('–í–≤–µ–¥–∏ –∫–æ–¥ –∏–≥—Ä—ã –∏ –∏–º—è!');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏–≥—Ä—ã
            const gameRef = ref(database, `games/${gameCode}`);
            onValue(gameRef, (snapshot) => {
                const game = snapshot.val();
                if(game && game.status === 'waiting') {
                    // –î–æ–±–∞–≤–ª—è–µ–º –∏–≥—Ä–æ–∫–∞
                    const playersRef = ref(database, `games/${gameCode}/players`);
                    const newPlayerRef = push(playersRef);
                    playerId = newPlayerRef.key;
                    
                    update(newPlayerRef, {
                        name: playerName,
                        team: currentTeam,
                        x: Math.floor(Math.random() * 10) + 2,
                        y: Math.floor(Math.random() * 10) + 2,
                        notebooks: 0,
                        caught: false
                    });
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω
                    document.getElementById('joinForm').style.display = 'none';
                    document.getElementById('playerGame').style.display = 'block';
                    document.getElementById('playerCanvas').style.display = 'block';
                    
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É
                    startPlayerGame(gameCode, playerId);
                } else if(game && game.status === 'playing') {
                    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ —É–∂–µ –Ω–∞—á–∞—Ç–æ–π –∏–≥—Ä–µ
                    alert('–ò–≥—Ä–∞ —É–∂–µ –Ω–∞—á–∞–ª–∞—Å—å!');
                } else {
                    alert('–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
                }
            }, { onlyOnce: true });
        };
        
        function startPlayerGame(code, pId) {
            const canvas = document.getElementById('playerCanvas');
            const ctx = canvas.getContext('2d');
            
            const gameRef = ref(database, `games/${code}`);
            onValue(gameRef, (snapshot) => {
                const game = snapshot.val();
                if(game) {
                    drawPlayerView(ctx, game, pId);
                    updateTeamScore(game, pId);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–æ–π–º–∞–Ω –ª–∏ –∏–≥—Ä–æ–∫
                    const player = game.players[pId];
                    if(player && player.caught && !isCaught) {
                        catchPlayer();
                    }
                }
            });
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            document.getElementById('moveUp').onclick = () => move('up', code, pId);
            document.getElementById('moveDown').onclick = () => move('down', code, pId);
            document.getElementById('moveLeft').onclick = () => move('left', code, pId);
            document.getElementById('moveRight').onclick = () => move('right', code, pId);
            
            // –û—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å
            document.getElementById('submitAnswer').onclick = () => {
                const answer = document.getElementById('answerInput').value.toLowerCase().trim();
                if(currentQuestion && answer === currentQuestion.answer.toLowerCase()) {
                    // –ü—Ä–∞–≤–∏–ª—å–Ω–æ! –ó–∞–±–∏—Ä–∞–µ–º —Ç–µ—Ç—Ä–∞–¥–∫—É
                    update(ref(database, `games/${code}/notebooks/${currentQuestion.id}`), {
                        collected: true
                    });
                    
                    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç –∫–æ–º–∞–Ω–¥—ã
                    const gameRef = ref(database, `games/${code}`);
                    onValue(gameRef, (snapshot) => {
                        const game = snapshot.val();
                        if(game) {
                            const teamScore = game.teams[currentTeam].score || 0;
                            update(ref(database, `games/${code}/teams/${currentTeam}`), {
                                score: teamScore + 1
                            });
                        }
                    }, { onlyOnce: true });
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø
                    document.getElementById('questionPopup').classList.remove('active');
                    currentQuestion = null;
                } else {
                    // –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ! –ü—Ä–∏–≤–ª–µ–∫–∞–µ–º Baldi
                    alert('–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ! Baldi —É—Å–ª—ã—à–∞–ª —Ç–µ–±—è...');
                    document.getElementById('questionPopup').classList.remove('active');
                    currentQuestion = null;
                    
                    // –¢–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä—É–µ–º Baldi –±–ª–∏–∂–µ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
                    // –¢—É—Ç –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è Baldi
                }
            };
        }
        
        function drawPlayerView(ctx, game, pId) {
            const player = game.players[pId];
            if(!player) return;
            
            ctx.clearRect(0, 0, 400, 400);
            
            // –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É (—Ç–æ–ª—å–∫–æ –±–ª–∏–∂–∞–π—à–∏–µ –∫–ª–µ—Ç–∫–∏)
            const viewSize = 5;
            const startX = Math.max(0, player.x - 2);
            const startY = Math.max(0, player.y - 2);
            
            ctx.strokeStyle = '#444';
            ctx.lineWidth = 1;
            
            for(let i = 0; i <= viewSize; i++) {
                for(let j = 0; j <= viewSize; j++) {
                    ctx.strokeRect(i * 80, j * 80, 80, 80);
                }
            }
            
            // –†–∏—Å—É–µ–º –∏–≥—Ä–æ–∫–∞ –≤ —Ü–µ–Ω—Ç—Ä–µ
            ctx.fillStyle = game.teams[player.team].color;
            ctx.beginPath();
            ctx.arc(200, 200, 30, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = 'white';
            ctx.font = 'bold 16px Arial';
            ctx.fillText('üßë', 185, 210);
            
            // –†–∏—Å—É–µ–º –≤–∏–¥–∏–º—ã–µ —Ç–µ—Ç—Ä–∞–¥–∫–∏
            if(game.notebooks) {
                Object.entries(game.notebooks).forEach(([id, n]) => {
                    if(!n.collected && Math.abs(n.x - player.x) <= 2 && Math.abs(n.y - player.y) <= 2) {
                        const screenX = (n.x - startX) * 80 + 40;
                        const screenY = (n.y - startY) * 80 + 40;
                        
                        ctx.fillStyle = '#ffd700';
                        ctx.beginPath();
                        ctx.arc(screenX, screenY, 20, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // –ï—Å–ª–∏ —Ä—è–¥–æ–º, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å
                        if(Math.abs(n.x - player.x) <= 1 && Math.abs(n.y - player.y) <= 1) {
                            currentQuestion = { ...n, id };
                            document.getElementById('questionText').textContent = n.question;
                            document.getElementById('answerInput').value = '';
                            document.getElementById('questionPopup').classList.add('active');
                        }
                    }
                });
            }
            
            // –†–∏—Å—É–µ–º Baldi –µ—Å–ª–∏ –±–ª–∏–∑–∫–æ
            if(game.baldi && Math.abs(game.baldi.x - player.x) <= 2 && Math.abs(game.baldi.y - player.y) <= 2) {
                const screenX = (game.baldi.x - startX) * 80 + 40;
                const screenY = (game.baldi.y - startY) * 80 + 40;
                
                ctx.fillStyle = '#ff0000';
                ctx.beginPath();
                ctx.arc(screenX, screenY, 35, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = 'white';
                ctx.font = 'bold 20px Arial';
                ctx.fillText('üë®‚Äçüè´', screenX - 15, screenY + 5);
            }
        }
        
        function updateTeamScore(game, pId) {
            const player = game.players[pId];
            if(player) {
                const score = game.teams[player.team].score || 0;
                const teamColors = { team1: 'üî¥', team2: 'üîµ', team3: 'üü¢' };
                document.getElementById('playerTeamScore').textContent = 
                    `${teamColors[player.team]} ${score}`;
            }
        }
        
        function move(direction, gameCode, playerId) {
            if(isCaught) return;
            
            const gameRef = ref(database, `games/${gameCode}`);
            onValue(gameRef, (snapshot) => {
                const game = snapshot.val();
                if(game) {
                    const player = game.players[playerId];
                    if(!player) return;
                    
                    let newX = player.x;
                    let newY = player.y;
                    
                    switch(direction) {
                        case 'up': newY--; break;
                        case 'down': newY++; break;
                        case 'left': newX--; break;
                        case 'right': newX++; break;
                    }
                    
                    // –ì—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ä—Ç—ã
                    if(newX >= 0 && newX < 15 && newY >= 0 && newY < 15) {
                        update(ref(database, `games/${gameCode}/players/${playerId}`), {
                            x: newX,
                            y: newY
                        });
                    }
                }
            }, { onlyOnce: true });
        }
        
        function catchPlayer() {
            isCaught = true;
            document.getElementById('caughtMessage').classList.add('active');
            
            caughtTimer = setTimeout(() => {
                isCaught = false;
                document.getElementById('caughtMessage').classList.remove('active');
            }, 10000);
        }
    </script>
</body>
</html>
