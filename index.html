<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BaldieEnglish ‚Äî –£—á–∏—Ç–µ–ª—å</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- –õ–æ–±–±–∏ (—Å–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä—ã) -->
    <div id="lobby" class="lobby-container">
        <div class="lobby-header">
            <h1>üè´ BaldieEnglish</h1>
            <h2>–£—á–∏—Ç–µ–ª—å—Å–∫–∞—è –ø–∞–Ω–µ–ª—å</h2>
        </div>
        
        <button id="createGameBtn" class="start-btn">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É</button>
        
        <div id="gameCodeDisplay" class="game-code" style="display: none;">
            <div>–ö–æ–¥ –∏–≥—Ä—ã:</div>
            <div class="code" id="gameCode">XXXXXX</div>
            <div style="margin-top: 1rem; color: #888;">–°–∫–∞–∂–∏—Ç–µ –∫–æ–¥ —É—á–µ–Ω–∏–∫–∞–º</div>
        </div>
        
        <div id="lobbyTeams" style="display: none;">
            <div class="teams-container">
                <div class="team-card team1">
                    <h3>üî¥ –ö–æ–º–∞–Ω–¥–∞ 1</h3>
                    <ul id="team1Players" class="players-list"></ul>
                </div>
                <div class="team-card team2">
                    <h3>üîµ –ö–æ–º–∞–Ω–¥–∞ 2</h3>
                    <ul id="team2Players" class="players-list"></ul>
                </div>
                <div class="team-card team3">
                    <h3>üü¢ –ö–æ–º–∞–Ω–¥–∞ 3</h3>
                    <ul id="team3Players" class="players-list"></ul>
                </div>
            </div>
            
            <button id="startGameBtn" class="start-btn">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
        </div>
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω —É—á–∏—Ç–µ–ª—è (–∫–∞—Ä—Ç–∞) -->
    <div id="teacherGame" class="teacher-container" style="display: none;">
        <div class="game-header">
            <div class="team-scores">
                <span class="team-score-badge team1" id="score1">üî¥ 0</span>
                <span class="team-score-badge team2" id="score2">üîµ 0</span>
                <span class="team-score-badge team3" id="score3">üü¢ 0</span>
            </div>
            <button id="backToLobbyBtn" class="back-btn">‚Üê –í –ª–æ–±–±–∏</button>
        </div>
        <canvas id="gameCanvas" width="800" height="800"></canvas>
    </div>

    <script type="module">
        import { createGame } from './script.js';
        import { database } from './firebase-config.js';
        import { ref, onValue, update } from 'firebase/database';
        
        let currentGameCode = null;
        
        document.getElementById('createGameBtn').onclick = () => {
            currentGameCode = createGame();
            document.getElementById('gameCode').textContent = currentGameCode;
            document.getElementById('gameCodeDisplay').style.display = 'block';
            document.getElementById('lobbyTeams').style.display = 'block';
            
            // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∏–≥—Ä–µ
            const gameRef = ref(database, `games/${currentGameCode}`);
            onValue(gameRef, (snapshot) => {
                const game = snapshot.val();
                if(game) {
                    updateLobby(game);
                }
            });
        };
        
        function updateLobby(game) {
            // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–∫–∏ –∏–≥—Ä–æ–∫–æ–≤
            ['team1', 'team2', 'team3'].forEach(team => {
                const list = document.getElementById(`${team}Players`);
                list.innerHTML = '';
            });
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–≥—Ä–æ–∫–∞–º–∏
            if(game.players) {
                Object.values(game.players).forEach(player => {
                    const li = document.createElement('li');
                    li.textContent = player.name;
                    document.getElementById(`${player.team}Players`).appendChild(li);
                });
            }
        }
        
        document.getElementById('startGameBtn').onclick = () => {
            if(currentGameCode) {
                update(ref(database, `games/${currentGameCode}`), {
                    status: 'playing'
                });
                
                document.getElementById('lobby').style.display = 'none';
                document.getElementById('teacherGame').style.display = 'flex';
                startGame(currentGameCode);
            }
        };
        
        document.getElementById('backToLobbyBtn').onclick = () => {
            document.getElementById('teacherGame').style.display = 'none';
            document.getElementById('lobby').style.display = 'block';
        };
        
        function startGame(gameCode) {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            
            const gameRef = ref(database, `games/${gameCode}`);
            onValue(gameRef, (snapshot) => {
                const game = snapshot.val();
                if(game && game.status === 'playing') {
                    drawMap(ctx, game);
                    updateScores(game);
                }
            });
        }
        
        function drawMap(ctx, game) {
            ctx.clearRect(0, 0, 800, 800);
            
            // –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É
            ctx.strokeStyle = '#444';
            ctx.lineWidth = 1;
            for(let i = 0; i <= 15; i++) {
                ctx.beginPath();
                ctx.moveTo(i * 50, 0);
                ctx.lineTo(i * 50, 800);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(0, i * 50);
                ctx.lineTo(800, i * 50);
                ctx.stroke();
            }
            
            // –†–∏—Å—É–µ–º —Ç–µ—Ç—Ä–∞–¥–∫–∏
            if(game.notebooks) {
                Object.values(game.notebooks).forEach(n => {
                    if(!n.collected) {
                        ctx.fillStyle = '#ffd700';
                        ctx.beginPath();
                        ctx.arc(n.x * 50 + 25, n.y * 50 + 25, 15, 0, Math.PI * 2);
                        ctx.fill();
                    }
                });
            }
            
            // –†–∏—Å—É–µ–º –∏–≥—Ä–æ–∫–æ–≤
            if(game.players) {
                Object.values(game.players).forEach(p => {
                    ctx.fillStyle = game.teams[p.team].color;
                    ctx.beginPath();
                    ctx.arc(p.x * 50 + 25, p.y * 50 + 25, 20, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // –ò–º—è –∏–≥—Ä–æ–∫–∞
                    ctx.fillStyle = 'white';
                    ctx.font = '12px Arial';
                    ctx.fillText(p.name, p.x * 50 + 15, p.y * 50 + 10);
                });
            }
            
            // –†–∏—Å—É–µ–º Baldi
            if(game.baldi) {
                ctx.fillStyle = '#ff0000';
                ctx.beginPath();
                ctx.arc(game.baldi.x * 50 + 25, game.baldi.y * 50 + 25, 25, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = 'white';
                ctx.font = 'bold 16px Arial';
                ctx.fillText('üë®‚Äçüè´', game.baldi.x * 50 + 15, game.baldi.y * 50 + 30);
            }
        }
        
        function updateScores(game) {
            document.getElementById('score1').textContent = `üî¥ ${game.teams.team1.score || 0}`;
            document.getElementById('score2').textContent = `üîµ ${game.teams.team2.score || 0}`;
            document.getElementById('score3').textContent = `üü¢ ${game.teams.team3.score || 0}`;
        }
    </script>
</body>
</html>
